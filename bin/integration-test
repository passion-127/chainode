#!/bin/bash
# Bash script to execute integration tests

# Docker compose custom wrapper for test environment
function docker-test-env {
  docker-compose -f network.yml -f kafka.yml -f mongodb.yml -f dev-app.yml -f integration-tests.yml $@
}

function create-kafka-topics {
  topics=( pending ledger )
  for i in "${topics[@]}"
  do
    topic="blockchain.blocks.$i"
    echo "Trying to create the kafka topic $topic"
    docker exec -it confluentkafka /bin/bash -c "/confluent/bin/kafka-topics --create --zookeeper localhost:2181 --replication-factor 1 --partitions 3 --topic $topic --if-not-exists"
  done
}

# Start test environment
echo -e "Starting dockerized environment."
cd docker-compose/
docker-test-env up -d
sleep 5
create-kafka-topics
sleep 5

# Execute integration tests
docker exec -it nodejs npm test
echo -e "Completed all integration tests."
sleep 5

# Stop the test environment
docker-test-env down
cd ../
echo -e "Shutdown of dockerized environment."
